<html>

<head>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    #airplane {
      background-color: rgb(172, 212, 228);
    }
  </style>
</head>

<body>
  <svg id="airplane" height="500" width="500"></svg>
  </br>
  <input id="slider" type="range" min="0" max="318" step="1">
</body>

<script>
  const svg = d3.select("svg#airplane");

  const width = svg.attr("width");
  const height = svg.attr("height");

  const margin = { top: 10, right: 10, bottom: 10, left: 10 };

  const chartWidth = width - margin.left - margin.right;
  const chartHeight = height - margin.top - margin.bottom;

  let chartArea = svg.append("g").attr("id", "points")
    .attr("transform", `translate(-50,-50)`);

  d3.csv("datasets/us_travel_daily.csv", d3.autoType)
    .then((data) => {
      let dataCleaned = [];

      // year removed from date column
      data.forEach((d) => {
        d["Date"] = d["Date"].substring(0, d["Date"].lastIndexOf("/"))
      });

      // flatten the number of travelers for each year
      for (let c = 2019; c <= 2021; c++) {
        for (let i = 0; i <= data.length; i++) {
          if (data[i]) {
            dataCleaned.push({
              "date": new Date(data[i]["Date"] + "/" + c),
              "travelers": data[i][c + " Traveler Throughput"] ? Number(data[i][c + " Traveler Throughput"].replace(/,/g, '')) : 0
            });
          }
        }
      }

      // filter the dates
      var startDate = new Date("1/21/2020");
      var endDate = new Date("12/5/2020");

      dataCleaned = dataCleaned.filter((d) => {
        return d["date"] >= startDate && d["date"] <= endDate;
      });

      dataCleaned = dataCleaned.sort((a, b) => (a["date"] > b["date"]) ? 1 : -1);

      // call when slider changes
      function showTravelers(index) {
        const numExtent = d3.extent(dataCleaned, d => d['travelers']);
        let numSquare = Math.ceil((dataCleaned[index]["travelers"] / numExtent[1]) * 100);

        let rects = [];
        let n = 0;
        let brightColor = '#60a3b2';
        let darkColor = '#427885';

        for (let y = 0; y < 10; y++) {
          for (let x = 0; x < 10; x++) {
            n++;
            if (n > numSquare && x >= 5) {
              rects.push(
                {
                  x: x * 27,
                  y: y * 30,
                  color: brightColor
                });
            } else if (n > numSquare) {
              rects.push(
                {
                  x: x * 25,
                  y: y * 30,
                  color: brightColor
                });
            } else if (n <= numSquare && x >= 5) {
              rects.push(
                {
                  x: x * 27,
                  y: y * 30,
                  color: darkColor
                });
            } else {
              rects.push(
                {
                  x: x * 25,
                  y: y * 30,
                  color: darkColor
                });
            }
          }
        }

        // rectangles
        rects.forEach((d, i) => {
          let rect = chartArea.append("rect")
            .attr('x', 250 + d["x"])
            .attr('y', 250 + d["y"])
            .attr('width', 20)
            .attr('height', 25)
            .attr('fill', d["color"])
            .attr("transform", `translate(-100,-100)`);
        });
      }

      showTravelers(159);

      let slider = document.getElementById("slider");
      slider.addEventListener('input', () => showTravelers(slider.value));
    }, (error) => {
      console.log(error);
    });

</script>

</html>
<html>
    <head>
        <script src="https://d3js.org/d3.v6.min.js"></script>
        <script src="https://d3js.org/topojson.v3.min.js"></script>

        <style>
            .mouseover {
                stroke: black;
                fill: none;
                stroke-width: 3px;
                pointer-events: none;
            }
        </style>
    </head>

    <body>
        <svg id="usCovidSvg" height="610" width="975"></svg>
        <div>
            <p id="date"></p>
            <input id="slider" type="range" min="0" max="419" step="1" value="0">
        </div>
        <div>
            <p id="stateName"></p>
            <p id="stateCount"></p>
        </div>
    </body>

    <script>
        const usCovidSvg = d3.select("#usCovidSvg");
        const usCovidWidth = usCovidSvg.attr("width");
        const usCovidHeight = usCovidSvg.attr("height");
        const usCovidMap = usCovidSvg.append("g");

        const requestData = async function() {
            const us = await d3.json("datasets/counties-10m.json");
            const usCovidStates = await d3.csv("datasets/all-states-history.csv");
            const usStateNames = await d3.tsv("datasets/us-state-names.tsv");
            // const timeParser = d3.timeParse('%Y-%m-%d');
            console.log(usCovidStates);

            // list of state codes
            let stateCodes = []
            usCovidStates.slice(0,56).forEach(d => {
                stateCodes.push(d.state);
            });

            // state id to code
            let idToState = {}
            usStateNames.forEach( d => {
                if(stateCodes.indexOf(d.code) > -1) {
                    idToState[d.id] = d.code;
                }
            });
            console.log(idToState);

            // state covid count by date
            let stateByDate = [];
            usCovidStates.forEach(d => {
                let positiveIncrease = parseInt(d.positiveIncrease);
                if (positiveIncrease > -1) {
                    if (!stateByDate.some(e => e.date === d.date)) {
                        stateByDate.push({
                            "date": d.date,
                            "states": {}
                        })
                        stateByDate.find(e => e.date == d.date).states[d.state] = positiveIncrease;
                    } else {
                        stateByDate.find(e => e.date == d.date).states[d.state] = positiveIncrease;
                    }
                }
            });
            // invert stateByDate order to match chronological order
            stateByDate = stateByDate.reverse();
            console.log(stateByDate);

            // map projection
            let projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
            let path = d3.geoPath().projection(projection);

            let nation = topojson.feature(us, us.objects.nation);
            let states = topojson.feature(us, us.objects.states);
            let statesMesh = topojson.mesh(us, us.objects.states);

            usCovidMap.selectAll("path.states").data(states.features)
                      .join("path")
                      .attr("class", "states")
                      .attr("d", path)
                      .attr("fill", "#d8d8d8")
                      .attr("note", d => d.id);
                
            usCovidMap.append("path").datum(statesMesh)
                      .attr("class","outline")
                      .attr("fill", "none")
                      .attr("stroke", "white")
                      .attr("stroke-width", 1)
                      .attr("d", path);

            let newMesh = usCovidMap.append("path")
                                    .attr("class","mouseover")
                                    .attr("d", "");

            // State mouse enter
            function mouseEnterState() {
                let state = d3.select(this);
                let stateID = state.datum().id;
                let date = document.getElementById("date").innerHTML;
                let data = stateByDate.find(e => e.date == date).states;
                
                let code = idToState[parseInt(stateID)]
                let name = usStateNames.find(element => element.code === code).name;
                let count = data[code];

                console.log(code);
                console.log(name);
                console.log(count);

                document.getElementById("stateName").innerHTML = name;
                document.getElementById("stateCount").innerHTML = count > 0 ? count : 0;

                let mouseOverState = topojson.mesh(us, us.objects.states, function(a, b) { return a.id === stateID || b.id === stateID; });
                newMesh.datum(mouseOverState).attr("d", path)
            }
            
            // State mouse out
            function mouseLeaveState() {
                let state = d3.select(this);
                document.getElementById("stateName").innerHTML = "";
                document.getElementById("stateCount").innerHTML = "";
                newMesh.attr("d", "")
            }

            // Color scale
            const colorScale = d3.scaleQuantile()
                                 .domain([0,10000])
                                 .range(["#ffd9d9","#ffa8a8","#ff5e5e","#ff2929"]);

            // Render states
            function renderStates(selectedDate) {
                
                document.getElementById("date").innerHTML = selectedDate.date;

                usCovidMap.selectAll(".states")
                          .style("fill", d => colorScale( selectedDate.states[idToState[parseInt(d.id)]]))
                          .on("mouseenter", mouseEnterState)
                          .on("mouseout",  mouseLeaveState);
            }

            // render default
            renderStates(stateByDate[slider.value])

            //slider
            slider.addEventListener('input', () => renderStates(stateByDate[slider.value]))
        }
        requestData();

    </script>

</html>
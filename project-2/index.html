<html>

<head>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <div class="intro">
        <h1>How the <span>Coronavirus</span> Affected U.S. States and Air Travel</h1>
        <p class="name">Yubin Heo, Jason Kim, Toby Ko</p>
        <p>The COVID-19 pandemic has given significant impact to everyone's lives around the world. 
            Although the vaccine rollouts have provided relief from the terrifying speed of the infection, 
            the coronavirus and its increasing number of mutations still remain at risk. Our project focuses
            on identifying the relationship between the pandemic and air travel to directly visualize 
            how the virus affected the travel industry.</p>
        <div class="slider-date">
            <input class="slider" id="slider" type="range" min="0" max="418" step="1" value="0">
            <p id="date"></p>
        </div>
        <ul class="slider-ticks">
            <li class="ticks">JAN</li>
            <li class="ticks">FEB</li>
            <li class="ticks">MAR</li>
            <li class="ticks">APR</li>
            <li class="ticks">MAY</li>
            <li class="ticks">JUN</li>
            <li class="ticks">JUL</li>
            <li class="ticks">AUG</li>
            <li class="ticks">SEP</li>
            <li class="ticks">OCT</li>
            <li class="ticks">NOV</li>
            <li class="ticks">DEC</li>
            <li class="ticks">JAN</li>
            <li class="ticks">FEB</li>
            <li class="ticks">MAR</li>
        </ul>
    </div>
    <div class="svg-title">
        <h1 class="svg-title" id="map-title">Daily New Cases in U.S. States</h1>
        <h1 class="svg-title" id="plane-title">Daily Traveler Throughput</h1>
    </div>
    <div class="data-visual">
        <div class="map">
            <svg id="usCovidSvg" height="650" width="975"></svg>
        </div>
        <div class="plane">
            <svg id="airplane" height="550" width="350"></svg>
        </div>
    </div>
</body>

<script>
    const usCovidSvg = d3.select("#usCovidSvg");
    const usCovidWidth = usCovidSvg.attr("width");
    const usCovidHeight = usCovidSvg.attr("height");
    const usCovidMap = usCovidSvg.append("g");

    const requestData = async function () {
        // load data
        const us = await d3.json("datasets/counties-10m.json");
        const usCovidStates = await d3.csv("datasets/all-states-history.csv");
        const usStateNames = await d3.tsv("datasets/us-state-names.tsv");
        console.log(usCovidStates);

        // generate state code list used in usCovidStates
        let stateCodes = []
        usCovidStates.slice(0, 56).forEach(d => {
            stateCodes.push(d.state);
        });

        // map state id to state code
        let idToState = {}
        usStateNames.forEach(d => {
            if (stateCodes.indexOf(d.code) > -1) {
                idToState[d.id] = d.code;
            }
        });

        // reorganize 56 states covid data by date
        let stateByDate = [];
        usCovidStates.forEach(d => {
            let positiveIncrease = parseInt(d.positiveIncrease);
            if (positiveIncrease > -1) {
                if (!stateByDate.some(e => e.date === d.date)) {
                    stateByDate.push({
                        "date": d.date,
                        "states": {}
                    })
                    stateByDate.find(e => e.date == d.date).states[d.state] = positiveIncrease;
                } else {
                    stateByDate.find(e => e.date == d.date).states[d.state] = positiveIncrease;
                }
            }
        });
        // invert stateByDate order to match chronological order
        stateByDate = stateByDate.reverse();
        console.log(stateByDate);

        // initial map projection
        let projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
        let path = d3.geoPath().projection(projection);

        let nation = topojson.feature(us, us.objects.nation);
        let states = topojson.feature(us, us.objects.states);
        let statesMesh = topojson.mesh(us, us.objects.states);

        usCovidMap.append("path").datum(statesMesh)
            .attr("class", "outline")
            .attr("fill", "none")
            .attr("d", path);

        usCovidMap.selectAll("path.states").data(states.features)
            .join("path")
            .attr("class", "states")
            .attr("d", path)
            .attr("fill", "#e9e9e9")
            .attr("stroke", "white")
            .attr("stroke-width", 1)
            .attr("note", d => d.id)
            .on("mouseenter", mouseEnterState)
            .on("mouseout", mouseLeaveState);

        // tooltip setup
        let tooltipWidth = 100;
        let tooltipHeight = 50;

        let tooltip = usCovidMap.append("g")
            .attr("visibility", "hidden");

        tooltip.append("rect")
            .attr("fill", "rgb(95, 95, 95)")
            .attr("x", -tooltipWidth / 2.0)
            .attr("y", 0)
            .attr("rx", 5)
            .attr("ry", 5)
            .attr("width", tooltipWidth)
            .attr("height", tooltipHeight)

        let textName = tooltip.append("text")
            .attr("id", "stateName")
            .attr("fill", "white")
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "hanging")
            .attr("font-size", "13px")
            .attr("x", 0)
            .attr("y", 8);

        let textCount = tooltip.append("text")
            .attr("id", "stateCount")
            .attr("fill", "white")
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "hanging")
            .attr("font-size", "13px")
            .attr("x", 0)
            .attr("y", 28);

        // newMesh for mouseover
        let newMesh = usCovidMap.append("path")
            .attr("class", "mouseover")
            .attr("d", "");

        // mouse enter function
        function mouseEnterState() {
            let state = d3.select(this);
            let stateID = state.datum().id;
            let date = document.getElementById("date").innerHTML;
            let data = stateByDate.find(e => e.date == date).states;

            let code = idToState[parseInt(stateID)]
            let name = usStateNames.find(element => element.code === code).name;
            let count = data[code];

            // fade out other states
            usCovidMap.selectAll(".states")
                .attr("opacity", 0.3)

            // highlight and shadow effect
            state.attr("opacity", 1).style("filter", "drop-shadow(10px 10px 5px rgba(0,0,0,0.5))")

            // tooltip
            tooltip.style("visibility", "visible")
            let bounds = path.bounds(state.datum());
            let xPos = (bounds[0][0] + bounds[1][0]) / 2.0;
            let yPos = bounds[1][1];
            let tipHeight = bounds[1][1] - bounds[0][1];
            if (yPos > 350) {
                tooltip.attr("transform", `translate(${xPos},${yPos - tipHeight - tooltipHeight - 10})`);
            } else {
                tooltip.attr("transform", `translate(${xPos},${yPos + 10})`);
            }

            // text
            textName.text(name);
            textCount.text(count > 0 ? count : 0)

            // mouseover state
            let mouseOverState = topojson.mesh(us, us.objects.states, function (a, b) { return a.id === stateID || b.id === stateID; });
            newMesh.datum(mouseOverState).attr("d", path)
        }

        // mouse out function
        function mouseLeaveState() {
            let state = d3.select(this);
            state.style("filter", "none")

            usCovidMap.selectAll(".states")
                .attr("opacity", 1)

            tooltip.style("visibility", "hidden");

            document.getElementById("stateName").innerHTML = "";
            document.getElementById("stateCount").innerHTML = "";

            newMesh.attr("d", "")
        }

        // color scale (hardcoded 10,000 due to outliers)
        const colorScale = d3.scaleQuantile()
            .domain([0, 10000])
            .range(["#ffd9d9", "#ffa8a8", "#ff5e5e", "#ff2929"]);

        // function that re-renders states according to selectedDate
        function renderStates(selectedDate) {

            document.getElementById("date").innerHTML = selectedDate.date;

            usCovidMap.selectAll(".states")
                .transition().duration(150)
                .style("fill", d => colorScale(selectedDate.states[idToState[parseInt(d.id)]]))
        }

        // default render
        renderStates(stateByDate[slider.value])

        // slider eventListener
        slider.addEventListener('input', () => renderStates(stateByDate[slider.value]))
    }
    requestData();

</script>

<script>
    const svg = d3.select("svg#airplane");

    const width = svg.attr("width");
    const height = svg.attr("height");

    const margin = { top: 10, right: 10, bottom: 10, left: 10 };

    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;

    let chartArea = svg.append("g").attr("id", "points")
        .attr("transform", `translate(-140,-130)`);

    d3.csv("datasets/us_travel_daily.csv", d3.autoType)
        .then((data) => {
            let dataCleaned = [];

            // year removed from date column
            data.forEach((d) => {
                d["Date"] = d["Date"].substring(0, d["Date"].lastIndexOf("/"))
            });

            // flatten the number of travelers for each year
            for (let c = 2019; c <= 2021; c++) {
                for (let i = 0; i <= data.length; i++) {
                    if (data[i]) {
                        dataCleaned.push({
                            "date": new Date(data[i]["Date"] + "/" + c),
                            "travelers": data[i][c + " Traveler Throughput"] ? Number(data[i][c + " Traveler Throughput"].replace(/,/g, '')) : 0
                        });
                    }
                }
            }

            // filter the dates
            var startDate = new Date("1/21/2020");
            var endDate = new Date("12/5/2020");

            dataCleaned = dataCleaned.filter((d) => {
                return d["date"] >= startDate && d["date"] <= endDate;
            });

            dataCleaned = dataCleaned.sort((a, b) => (a["date"] > b["date"]) ? 1 : -1);

            // call when slider changes
            function showTravelers(index) {
                const numExtent = d3.extent(dataCleaned, d => d['travelers']);
                let numSquare = Math.ceil((dataCleaned[index]["travelers"] / numExtent[1]) * 96);

                let rects = [];
                let n = 0;
                let brightColor = '#c9cbcc';
                let darkColor = '#585858';

                for (let y = 0; y < 16; y++) {
                    for (let x = 0; x < 6; x++) {
                        n++;
                        if (n > numSquare && x >= 3) {
                            rects.push(
                                {
                                    x: x * 20 + 10,
                                    y: y * 25,
                                    color: brightColor
                                });
                        } else if (n > numSquare) {
                            rects.push(
                                {
                                    x: x * 20,
                                    y: y * 25,
                                    color: brightColor
                                });
                        } else if (n <= numSquare && x >= 3) {
                            rects.push(
                                {
                                    x: x * 20 + 10,
                                    y: y * 25,
                                    color: darkColor
                                });
                        } else {
                            rects.push(
                                {
                                    x: x * 20,
                                    y: y * 25,
                                    color: darkColor
                                });
                        }
                    }
                }

                chartArea.selectAll("rect").data(rects)
                    .join(
                        enter => {
                            enter.append("rect")
                                .attr('x', d => 250 + d["x"])
                                .attr('y', d => 250 + d["y"])
                                .attr('width', 15)
                                .attr('height', 20)
                                .attr('fill', d => d["color"])
                        },
                        update => update
                            .transition().duration(150)
                            .attr('fill', d => d["color"]),
                        exit => {
                            exit.remove()
                        }
                    );
            }

            showTravelers(0);

            let slider = document.getElementById("slider");
            slider.addEventListener('input', () => showTravelers(slider.value));

        }, (error) => {
            console.log(error);
        });

</script>

</html>
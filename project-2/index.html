<html>

<head>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>

    <style>
        .mouseover {
            stroke: #636363;
            fill: none;
            pointer-events: none;
        }

        .slider {
            -webkit-appearance: none;
            background: #d3d3d3;
            width: 800px;
            height: 15px;
            border-radius: 5px;
            margin-top: 30px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            background: #ff5e5e;
            cursor: pointer;
            width: 25px;
            height: 25px;
            border-radius: 5px;
        }

        #date {
            font-family: sans-serif;
            font-size: 100px;
        }
    </style>
</head>

<body>
    <p id="date"></p>
    <div>
        <svg id="usCovidSvg" height="650" width="975"></svg>
        <input class="slider" id="slider" type="range" min="0" max="418" step="1" value="0">
    </div>
</body>

<script>
    const usCovidSvg = d3.select("#usCovidSvg");
    const usCovidWidth = usCovidSvg.attr("width");
    const usCovidHeight = usCovidSvg.attr("height");
    const usCovidMap = usCovidSvg.append("g");

    const requestData = async function () {
        // load data
        const us = await d3.json("datasets/counties-10m.json");
        const usCovidStates = await d3.csv("datasets/all-states-history.csv");
        const usStateNames = await d3.tsv("datasets/us-state-names.tsv");
        console.log(usCovidStates);

        // generate state code list used in usCovidStates
        let stateCodes = []
        usCovidStates.slice(0, 56).forEach(d => {
            stateCodes.push(d.state);
        });

        // map state id to state code
        let idToState = {}
        usStateNames.forEach(d => {
            if (stateCodes.indexOf(d.code) > -1) {
                idToState[d.id] = d.code;
            }
        });

        // reorganize 56 states covid data by date
        let stateByDate = [];
        usCovidStates.forEach(d => {
            let positiveIncrease = parseInt(d.positiveIncrease);
            if (positiveIncrease > -1) {
                if (!stateByDate.some(e => e.date === d.date)) {
                    stateByDate.push({
                        "date": d.date,
                        "states": {}
                    })
                    stateByDate.find(e => e.date == d.date).states[d.state] = positiveIncrease;
                } else {
                    stateByDate.find(e => e.date == d.date).states[d.state] = positiveIncrease;
                }
            }
        });
        // invert stateByDate order to match chronological order
        stateByDate = stateByDate.reverse();
        console.log(stateByDate);

        // initial map projection
        let projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
        let path = d3.geoPath().projection(projection);

        let nation = topojson.feature(us, us.objects.nation);
        let states = topojson.feature(us, us.objects.states);
        let statesMesh = topojson.mesh(us, us.objects.states);

        usCovidMap.append("path").datum(statesMesh)
            .attr("class", "outline")
            .attr("fill", "none")
            .attr("d", path);

        usCovidMap.selectAll("path.states").data(states.features)
            .join("path")
            .attr("class", "states")
            .attr("d", path)
            .attr("fill", "#d8d8d8")
            .attr("stroke", "white")
            .attr("stroke-width", 1)
            .attr("note", d => d.id)
            .on("mouseenter", mouseEnterState)
            .on("mouseout", mouseLeaveState);

        // tooltip setup
        let tooltipWidth = 130;
        let tooltipHeight = 50;

        let tooltip = usCovidMap.append("g")
            .attr("visibility", "hidden");

        tooltip.append("rect")
            .attr("fill", "#454545")
            .attr("x", -tooltipWidth / 2.0)
            .attr("y", 0)
            .attr("rx", 5)
            .attr("ry", 5)
            .attr("width", tooltipWidth)
            .attr("height", tooltipHeight)

        let textName = tooltip.append("text")
            .attr("id", "stateName")
            .attr("fill", "white")
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "hanging")
            .attr("font-family", "sans-serif")
            .attr("x", 0)
            .attr("y", 8);

        let textCount = tooltip.append("text")
            .attr("id", "stateCount")
            .attr("fill", "white")
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "hanging")
            .attr("font-family", "sans-serif")
            .attr("x", 0)
            .attr("y", 28);

        // newMesh for mouseover
        let newMesh = usCovidMap.append("path")
            .attr("class", "mouseover")
            .attr("d", "");

        // mouse enter function
        function mouseEnterState() {
            let state = d3.select(this);
            let stateID = state.datum().id;
            let date = document.getElementById("date").innerHTML;
            let data = stateByDate.find(e => e.date == date).states;

            let code = idToState[parseInt(stateID)]
            let name = usStateNames.find(element => element.code === code).name;
            let count = data[code];

            // fade out other states
            usCovidMap.selectAll(".states")
                .attr("opacity", 0.3)

            // highlight and shadow effect
            state.attr("opacity", 1).style("filter", "drop-shadow(12px 12px 7px rgba(0,0,0,0.5))")

            // tooltip
            tooltip.style("visibility", "visible")
            let bounds = path.bounds(state.datum());
            let xPos = (bounds[0][0] + bounds[1][0]) / 2.0;
            let yPos = bounds[1][1];
            let tipHeight = bounds[1][1] - bounds[0][1];
            if (yPos > 350) {
                tooltip.attr("transform", `translate(${xPos},${yPos - tipHeight - tooltipHeight - 10})`);
            } else {
                tooltip.attr("transform", `translate(${xPos},${yPos + 10})`);
            }

            // text
            textName.text(name);
            textCount.text(count > 0 ? count : 0)

            // mouseover state
            let mouseOverState = topojson.mesh(us, us.objects.states, function (a, b) { return a.id === stateID || b.id === stateID; });
            newMesh.datum(mouseOverState).attr("d", path)
        }

        // mouse out function
        function mouseLeaveState() {
            let state = d3.select(this);
            state.style("filter", "none")

            usCovidMap.selectAll(".states")
                .attr("opacity", 1)

            tooltip.style("visibility", "hidden");

            document.getElementById("stateName").innerHTML = "";
            document.getElementById("stateCount").innerHTML = "";

            newMesh.attr("d", "")
        }
    });
    // invert stateByDate order to match chronological order
    stateByDate = stateByDate.reverse();
    console.log(stateByDate);

    // map projection
    let projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
    let path = d3.geoPath().projection(projection);

    let nation = topojson.feature(us, us.objects.nation);
    let states = topojson.feature(us, us.objects.states);
    let statesMesh = topojson.mesh(us, us.objects.states);

    usCovidMap.selectAll("path.states").data(states.features)
        .join("path")
        .attr("class", "states")
        .attr("d", path)
        .attr("fill", "#d8d8d8")
        .attr("note", d => d.id)
        .on("mouseenter", mouseEnterState)
        .on("mouseout", mouseLeaveState);

    usCovidMap.append("path").datum(statesMesh)
        .attr("class", "outline")
        .attr("fill", "none")
        .attr("stroke", "white")
        .attr("stroke-width", 1)
        .attr("d", path);

    let newMesh = usCovidMap.append("path")
        .attr("class", "mouseover")
        .attr("d", "");

    // State mouse enter
    function mouseEnterState() {
        let state = d3.select(this);
        let stateID = state.datum().id;
        let date = document.getElementById("date").innerHTML;
        let data = stateByDate.find(e => e.date == date).states;

        let code = idToState[parseInt(stateID)]
        let name = usStateNames.find(element => element.code === code).name;
        let count = data[code];

        document.getElementById("stateName").innerHTML = name;
        document.getElementById("stateCount").innerHTML = count > 0 ? count : 0;

        let mouseOverState = topojson.mesh(us, us.objects.states, function (a, b) { return a.id === stateID || b.id === stateID; });
        newMesh.datum(mouseOverState).attr("d", path)
    }

<<<<<<< HEAD
    // State mouse out
    function mouseLeaveState() {
        let state = d3.select(this);
        document.getElementById("stateName").innerHTML = "";
        document.getElementById("stateCount").innerHTML = "";
        newMesh.attr("d", "")
    }

    // Color scale
    const colorScale = d3.scaleQuantile()
        .domain([0, 10000])
        .range(["#ffd9d9", "#ffa8a8", "#ff5e5e", "#ff2929"]);

    // Render states
    function renderStates(selectedDate) {

        document.getElementById("date").innerHTML = selectedDate.date;

        usCovidMap.selectAll(".states")
            .transition().duration(200)
            .style("fill", d => colorScale(selectedDate.states[idToState[parseInt(d.id)]]))
=======
            // color scale (hardcoded 10,000 due to outliers)
            const colorScale = d3.scaleQuantile()
                                 .domain([0,10000])
                                 .range(["#ffd9d9","#ffa8a8","#ff5e5e","#ff2929"]);

            // function that re-renders states according to selectedDate
            function renderStates(selectedDate) {

                document.getElementById("date").innerHTML = selectedDate.date;

                usCovidMap.selectAll(".states")
                          .transition().duration(180)
                          .style("fill", d => colorScale( selectedDate.states[idToState[parseInt(d.id)]]))
            }

            // default render
            renderStates(stateByDate[slider.value])

            // slider eventListener
            slider.addEventListener('input', () => renderStates(stateByDate[slider.value]))
>>>>>>> d5d3e03ecf12f5f0d401b8497fccda295e59add5
    }

    // render default
    renderStates(stateByDate[slider.value])

    //slider
    slider.addEventListener('input', () => renderStates(stateByDate[slider.value]))
    }
    requestData();

</script>

</html>